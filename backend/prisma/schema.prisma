// backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- 1. 會員 (客戶) 資料模型 ---
model User {
  id                  String    @id @default(cuid())
  email               String    @unique
  passwordHash        String
  name                String?
  phone               String?
  defaultAddress      String?
  
  // 權限控制：Json 型別 (例如 ["PACKAGE_VIEW", "USER_MANAGE"])
  permissions         Json      @default("[]") 
  
  // 帳號狀態
  isActive            Boolean   @default(true) 

  // 忘記密碼欄位
  resetPasswordToken  String?
  resetPasswordExpire DateTime?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // 關聯
  packages            Package[]
  shipments           Shipment[]
  activityLogs        ActivityLog[] 
}

// --- 2. 包裹 (預報) 資料模型 ---
model Package {
  id                  String    @id @default(cuid())
  
  // [Security] 新增 @unique 確保單號唯一
  trackingNumber      String    @unique
  
  productName         String    
  quantity            Int       @default(1)
  note                String?

  // 圖片儲存：Json 型別 (存圖片路徑字串陣列)
  productImages       Json      @default("[]") 
  warehouseImages     Json      @default("[]") 
  warehouseThumbnails Json      @default("[]") // 縮圖路徑

  status              String    @default("PENDING") 
  
  // 倉庫數據：Json 型別 (存分箱明細物件陣列)
  arrivedBoxesJson    Json      @default("[]") 
  
  totalCalculatedFee  Float?
  warehouseRemark     String?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @default(now()) @updatedAt

  // 關聯
  userId              String
  user                User      @relation(fields: [userId], references: [id])

  shipmentId          String?
  shipment            Shipment? @relation(fields: [shipmentId], references: [id])

  @@index([userId])
  @@index([shipmentId])
}

// --- 3. 集運單資料模型 ---
model Shipment {
  id                    String    @id @default(cuid())
  
  // 收件資訊
  recipientName         String
  phone                 String
  shippingAddress       String
  idNumber              String    
  taxId                 String?   // 統編
  invoiceTitle          String?   // 發票抬頭
  
  note                  String?

  // 附加服務：Json 型別 (存 { floor: { selected: true, ... } })
  additionalServices    Json?     @default("{}")
  
  deliveryLocationRate  Float?    // 偏遠地區費率
  status                String    @default("PENDING_PAYMENT") 
  totalCost             Float?
  trackingNumberTW      String?   
  paymentProof          String?

  // 發票相關
  invoiceNumber         String?
  invoiceDate           DateTime?
  invoiceRandomCode     String?
  invoiceStatus         String?   // ISSUED, VOID
  
  // 商品證明：Json 型別 (存圖片路徑或連結)
  productUrl            String?
  shipmentProductImages Json      @default("[]")

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @default(now()) @updatedAt

  // 關聯
  userId                String
  user                  User      @relation(fields: [userId], references: [id])
  packages              Package[] 

  @@index([userId])
}

// --- 4. 估價單 (分享連結用) ---
model CalculationQuote {
  id                String    @id @default(cuid())
  createdAt         DateTime  @default(now())
  // 試算結果：Json 型別
  calculationResult Json    
}

// --- 5. 操作日誌 (Audit Log) ---
model ActivityLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  action    String 
  targetId  String?
  details   String?  

  userId    String
  userEmail String 
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
}

// --- 6. 系統全域設定 (System Settings) ---
model SystemSetting {
  key         String   @id  // e.g., "rates_config", "announcement"
  // 設定值：Json 型別，方便存取物件結構
  value       Json        
  description String?
  updatedAt   DateTime @updatedAt
}