// backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- 1. 會員 (客戶) 資料模型 ---
model User {
  id                  String    @id @default(cuid())
  email               String    @unique
  passwordHash        String
  name                String?
  phone               String?
  defaultAddress      String?
  
  // 權限控制 (JSON 陣列字串，如 ["CAN_MANAGE_USERS"])
  permissions         String    @default("[]") 
  
  // 帳號狀態
  isActive            Boolean   @default(true) 

  // 忘記密碼欄位
  resetPasswordToken  String?
  resetPasswordExpire DateTime?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // 關聯
  packages            Package[]
  shipments           Shipment[]
  activityLogs        ActivityLog[] 
}

// --- 2. 包裹 (預報) 資料模型 ---
model Package {
  id                  String    @id @default(cuid())
  
  trackingNumber      String    
  productName         String    
  quantity            Int       @default(1)
  note                String?

  // 圖片儲存 (JSON 字串陣列)
  productImages       String    @default("[]") 
  warehouseImages     String    @default("[]") 
  warehouseThumbnails String    @default("[]") // 縮圖路徑，優化前端載入

  status              String    @default("PENDING") 
  
  // 倉庫數據
  arrivedBoxesJson    String?   @default("[]") // 分箱數據 JSON
  totalCalculatedFee  Float?
  warehouseRemark     String?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @default(now()) @updatedAt

  // 關聯
  userId              String
  user                User      @relation(fields: [userId], references: [id])

  shipmentId          String?
  shipment            Shipment? @relation(fields: [shipmentId], references: [id])

  @@index([userId])
  @@index([shipmentId])
}

// --- 3. 集運單資料模型 ---
model Shipment {
  id                    String    @id @default(cuid())
  
  // 收件資訊
  recipientName         String
  phone                 String
  shippingAddress       String
  idNumber              String    
  taxId                 String?   // 統編
  invoiceTitle          String?   // 發票抬頭
  
  note                  String?
  additionalServices    String?   // JSON (附加服務：上樓、打木架等)
  deliveryLocationRate  Float?    // 偏遠地區費率
  status                String    @default("PENDING_PAYMENT") 
  totalCost             Float?
  trackingNumberTW      String?   
  paymentProof          String?

  // 發票相關
  invoiceNumber         String?
  invoiceDate           DateTime?
  invoiceRandomCode     String?
  invoiceStatus         String?

  // 商品證明
  productUrl            String?
  shipmentProductImages String?   @default("[]")

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @default(now()) @updatedAt

  // 關聯
  userId                String
  user                  User      @relation(fields: [userId], references: [id])
  packages              Package[] 

  @@index([userId])
}

// --- 4. 估價單 (分享連結用) ---
model CalculationQuote {
  id                String    @id @default(cuid())
  createdAt         DateTime  @default(now())
  calculationResult String    // JSON (儲存試算結果)
}

// --- 5. 操作日誌 (Audit Log) ---
model ActivityLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  action    String 
  targetId  String?
  details   String?  

  userId    String
  userEmail String 
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
}

// --- 6. 系統全域設定 (System Settings) ---
model SystemSetting {
  key         String   @id  // e.g., "rates_config", "announcement"
  value       String        // JSON string
  description String?
  updatedAt   DateTime @updatedAt
}