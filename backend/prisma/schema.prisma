// 這是 backend/prisma/schema.prisma (V4 系統設定版)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- 1. 會員 (客戶) 資料模型 ---
model User {
  id             String     @id @default(cuid())
  email          String     @unique
  passwordHash   String
  name           String?
  phone          String?
  defaultAddress String?
  
  // 用 permissions 陣列取代 role，儲存如 ["CAN_MANAGE_USERS", "CAN_VIEW_LOGS"]
  permissions    String     @default("[]") 

  isActive       Boolean    @default(true) 

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  packages       Package[]
  shipments      Shipment[]
  activityLogs   ActivityLog[] 
}

// --- 2. 包裹 (預報) 資料模型 ---
model Package {
  id                 String    @id @default(cuid())
  
  trackingNumber     String    
  productName        String    
  quantity           Int       @default(1)
  note               String?
  productImages      String    @default("[]") // JSON 陣列字串
  status             String    @default("PENDING") 

  arrivedBoxesJson   String?   @default("[]") // 倉庫測量的分箱數據 JSON
  totalCalculatedFee Float?
  warehouseImages    String    @default("[]") // 倉庫拍攝的照片 JSON
  warehouseRemark    String?
  
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @default(now()) @updatedAt

  userId             String
  user               User      @relation(fields: [userId], references: [id])

  shipmentId         String?
  shipment           Shipment? @relation(fields: [shipmentId], references: [id])

  @@index([userId])
  @@index([shipmentId])
}

// --- 3. 集運單資料模型 ---
model Shipment {
  id                   String    @id @default(cuid())
  
  recipientName        String
  phone                String
  shippingAddress      String
  idNumber             String    
  taxId                String?   // 統一編號
  invoiceTitle         String?   // 發票抬頭
  
  note                 String?
  additionalServices   String?   // JSON 物件字串
  deliveryLocationRate Float?    
  
  status               String    @default("PENDING_PAYMENT") 
  totalCost            Float?
  trackingNumberTW     String?   
  paymentProof         String?

  // 發票相關欄位
  invoiceNumber        String?   // 發票號碼 (例如 AB12345678)
  invoiceDate          DateTime? // 開立時間
  invoiceRandomCode    String?   // 隨機碼
  invoiceStatus        String?   // 狀態 (ISSUED, FAILED)

  // 商品證明
  productUrl           String?   // 購買連結
  shipmentProductImages String?  @default("[]") // 商品照片 (JSON陣列)   

  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @default(now()) @updatedAt

  userId               String
  user                 User      @relation(fields: [userId], references: [id])
  packages             Package[] 

  @@index([userId])
}

// --- 4. 估價單 (分享連結用) ---
model CalculationQuote {
  id                String    @id @default(cuid())
  createdAt         DateTime  @default(now())
  calculationResult String    // 儲存當下的計算結果 JSON
}

// --- 5. 操作日誌 (Audit Log) ---
model ActivityLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  action    String 
  targetId  String?
  details   String?  

  userId    String
  userEmail String 
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
}

// --- 6. [新增] 系統全域設定 (System Settings) ---
// 用於儲存運費費率、銀行帳號、公告等設定，取代寫死的 JSON 檔案
model SystemSetting {
  key         String   @id  // 設定鍵名 (如: "rates_config", "bank_info")
  value       String        // 設定內容 (通常是 JSON 字串)
  description String?       // 用途說明
  updatedAt   DateTime @updatedAt
}