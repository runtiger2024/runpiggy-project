<div id="create-shipment-modal" class="modal-overlay" style="display: none">
  <div class="modal-content modal-lg checkout-modal">
    <button class="modal-close">&times;</button>
    <div
      class="modal-header"
      style="
        border-bottom: 1px solid #eee;
        margin-bottom: 15px;
        padding-bottom: 10px;
      "
    >
      <h3><i class="fas fa-boxes"></i> 確認訂單 (合併打包)</h3>
    </div>
    <form id="create-shipment-form">
      <div class="checkout-layout">
        <div class="checkout-items">
          <h4
            style="
              margin-top: 0;
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            📦 包裹清單
            <span style="font-size: 13px; color: #666; font-weight: normal"
              >已選 <span id="checkout-total-count">0</span> 件</span
            >
          </h4>

          <div
            id="shipment-package-list"
            style="
              max-height: 250px;
              overflow-y: auto;
              margin-bottom: 15px;
              border: 1px solid #eee;
              border-radius: 4px;
              background: #fafafa;
            "
          ></div>

          <div
            class="cost-calculation-box"
            style="
              background: #f8f9fa;
              padding: 15px;
              border-radius: 8px;
              border: 1px solid #e9ecef;
            "
          >
            <h5
              style="
                margin: 0 0 10px 0;
                color: #2c3e50;
                font-weight: bold;
                border-bottom: 2px solid #ddd;
                padding-bottom: 5px;
              "
            >
              💰 費用試算明細
            </h5>

            <div
              id="weight-analysis-panel"
              style="
                margin-bottom: 12px;
                padding-bottom: 12px;
                border-bottom: 1px dashed #ccc;
                font-size: 13px;
              "
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  margin-bottom: 4px;
                "
              >
                <span>總實重 (Actual Weight):</span>
                <span id="calc-actual-weight" style="font-weight: 500"
                  >-- kg</span
                >
              </div>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  margin-bottom: 4px;
                "
              >
                <span>總材積 (Volumetric):</span>
                <span id="calc-volumetric" style="font-weight: 500">-- 材</span>
              </div>
              <div
                style="
                  background: #e3f2fd;
                  padding: 5px 8px;
                  border-radius: 4px;
                  color: #0d47a1;
                  margin-top: 5px;
                  font-size: 12px;
                  border-left: 3px solid #1976d2;
                "
              >
                <i class="fas fa-info-circle"></i> <strong>計費說明：</strong>
                取每箱「實重」與「材積重」較高者計算運費。
              </div>
            </div>

            <div id="api-fee-breakdown">
              <div style="text-align: center; color: #999; padding: 10px">
                <div
                  class="spinner"
                  style="width: 20px; height: 20px; display: inline-block"
                ></div>
                正在雲端精算運費...
              </div>
            </div>
          </div>
        </div>

        <div class="checkout-info-form">
          <div
            id="forklift-warning"
            class="alert alert-danger"
            style="display: none; margin-bottom: 15px; font-size: 13px"
          >
            <i class="fas fa-dolly"></i>
            <strong>超重提醒：</strong> 偵測到單件 > 100kg 包裹。<br />
            請確認台灣收件地址可<strong>自行安排堆高機</strong>下貨，否則司機可能無法派送。
          </div>

          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <h4>📝 收件資訊</h4>
            <button
              type="button"
              id="btn-select-recipient"
              class="btn btn-sm btn-outline-primary"
              style="width: auto; padding: 4px 10px"
            >
              <i class="fas fa-address-book"></i> 常用地址
            </button>
          </div>

          <div class="form-group">
            <label class="required">收件人</label
            ><input type="text" id="ship-name" class="form-control" required />
          </div>
          <div class="form-group">
            <label class="required">電話</label
            ><input type="tel" id="ship-phone" class="form-control" required />
          </div>

          <div class="form-group">
            <label class="required">配送地區</label>
            <div style="display: flex; gap: 5px; margin-bottom: 5px">
              <input
                type="text"
                id="ship-area-search"
                placeholder="搜尋地區..."
                class="form-control"
                style="flex: 1"
              />
              <div id="ship-search-results" class="search-dropdown"></div>
            </div>
            <select id="ship-delivery-location" class="form-control" required>
              <option value="" selected disabled>--- 載入中 ---</option>
            </select>
            <div
              id="ship-remote-area-info"
              style="
                display: none;
                background: #fff3e0;
                color: #e65100;
                padding: 8px;
                margin-top: 5px;
                border-radius: 4px;
                font-size: 13px;
                border: 1px solid #ffe0b2;
              "
            >
              <i class="fas fa-map-marker-alt"></i>
              <strong>偏遠地區加價：</strong><br />
              選定地區：<span
                id="ship-selected-area-name"
                style="font-weight: bold"
              ></span>
              <br />
              加收費率：<span
                id="ship-selected-area-fee"
                style="font-weight: bold; color: #d32f2f"
              ></span>
              / 材
            </div>
          </div>

          <div class="form-group">
            <label class="required">詳細地址</label
            ><input
              type="text"
              id="ship-street-address"
              class="form-control"
              placeholder="路/街/號/樓"
              required
            />
          </div>
          <div class="form-group">
            <label class="required">身分證 (報關用)</label
            ><input
              type="text"
              id="ship-idNumber"
              class="form-control"
              required
            />
          </div>

          <div
            class="form-section"
            style="
              margin-top: 15px;
              padding-top: 10px;
              border-top: 1px solid #eee;
            "
          >
            <h4 style="margin-bottom: 10px; color: #2c3e50">🛠️ 附加服務</h4>
            <div class="service-item" style="margin-bottom: 10px">
              <div style="display: flex; align-items: center; gap: 10px">
                <input
                  type="checkbox"
                  id="srv-floor"
                  style="width: 18px; height: 18px"
                />
                <label for="srv-floor" style="font-weight: bold; margin: 0"
                  >需要上樓搬運</label
                >
              </div>
              <div
                id="srv-floor-options"
                style="
                  display: none;
                  margin-left: 28px;
                  margin-top: 8px;
                  padding: 10px;
                  background: #f8f9fa;
                  border-radius: 5px;
                "
              >
                <div style="margin-bottom: 8px">
                  <label
                    style="font-size: 13px; display: block; margin-bottom: 3px"
                    >電梯設施：</label
                  >
                  <div style="display: flex; gap: 15px">
                    <label style="font-weight: normal; font-size: 14px"
                      ><input type="radio" name="srv-elevator" value="yes" />
                      有電梯</label
                    >
                    <label style="font-weight: normal; font-size: 14px"
                      ><input type="radio" name="srv-elevator" value="no" />
                      無電梯 (需爬梯)</label
                    >
                  </div>
                </div>
                <input
                  type="text"
                  id="srv-floor-note"
                  class="form-control"
                  placeholder="備註 (例: 5樓, 樓梯較窄)..."
                  style="font-size: 13px"
                />
              </div>
            </div>

            <div class="service-item" style="margin-bottom: 10px">
              <div style="display: flex; align-items: center; gap: 10px">
                <input
                  type="checkbox"
                  id="srv-wood"
                  style="width: 18px; height: 18px"
                /><label for="srv-wood" style="font-weight: bold; margin: 0"
                  >回收木架</label
                >
              </div>
              <div
                id="srv-wood-input"
                style="display: none; margin-left: 28px; margin-top: 5px"
              >
                <input
                  type="text"
                  id="srv-wood-note"
                  class="form-control"
                  placeholder="數量/備註..."
                  style="font-size: 13px"
                />
              </div>
            </div>
            <div class="service-item" style="margin-bottom: 10px">
              <div style="display: flex; align-items: center; gap: 10px">
                <input
                  type="checkbox"
                  id="srv-assembly"
                  style="width: 18px; height: 18px"
                /><label for="srv-assembly" style="font-weight: bold; margin: 0"
                  >傢俱組裝</label
                >
              </div>
              <div
                id="srv-assembly-input"
                style="display: none; margin-left: 28px; margin-top: 5px"
              >
                <input
                  type="text"
                  id="srv-assembly-note"
                  class="form-control"
                  placeholder="備註..."
                  style="font-size: 13px"
                />
              </div>
            </div>
            <div class="service-item" style="margin-bottom: 10px">
              <div style="display: flex; align-items: center; gap: 10px">
                <input
                  type="checkbox"
                  id="srv-old"
                  style="width: 18px; height: 18px"
                /><label for="srv-old" style="font-weight: bold; margin: 0"
                  >回收舊傢俱</label
                >
              </div>
              <div
                id="srv-old-input"
                style="display: none; margin-left: 28px; margin-top: 5px"
              >
                <input
                  type="text"
                  id="srv-old-note"
                  class="form-control"
                  placeholder="品項/數量 (例: 5樓, 樓梯較窄)..."
                  style="font-size: 13px"
                />
              </div>
            </div>

            <div
              class="alert alert-warning"
              style="
                display: block;
                margin-top: 10px;
                font-size: 12px;
                padding: 8px;
              "
            >
              <i class="fas fa-exclamation-circle"></i>
              附加服務費由司機現場報價並收取。
            </div>
          </div>

          <div
            class="form-section"
            style="
              margin-top: 15px;
              border-top: 1px dashed #ccc;
              padding-top: 10px;
            "
          >
            <h4 style="margin-bottom: 10px; color: #2c3e50">💳 付款方式</h4>
            <div style="display: flex; gap: 15px; margin-bottom: 10px">
              <label
                style="
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  gap: 5px;
                "
              >
                <input
                  type="radio"
                  name="paymentMethod"
                  id="pay-transfer"
                  value="TRANSFER"
                  checked
                  onchange="togglePaymentMethod('TRANSFER')"
                />
                <span>銀行轉帳</span>
              </label>
              <label
                style="
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  gap: 5px;
                "
              >
                <input
                  type="radio"
                  name="paymentMethod"
                  id="pay-wallet"
                  value="WALLET"
                  onchange="togglePaymentMethod('WALLET')"
                />
                <span>錢包餘額</span>
              </label>
            </div>
            <div
              id="wallet-pay-info"
              style="
                display: none;
                background: #e8f5e9;
                padding: 10px;
                border-radius: 5px;
                font-size: 13px;
                color: #2e7d32;
              "
            >
              正在檢查餘額...
            </div>
          </div>

          <div class="form-group" style="margin-top: 15px">
            <label>訂單備註</label
            ><input
              type="text"
              id="ship-note"
              class="form-control"
              placeholder="有什麼想告訴我們的嗎？"
            />
          </div>
        </div>
      </div>

      <div class="modal-footer sticky-footer-actions">
        <button type="button" class="btn btn-secondary modal-close-btn">
          取消
        </button>
        <button type="submit" class="btn btn-primary btn-place-order">
          <i class="fas fa-paper-plane"></i> 提交訂單
        </button>
      </div>
    </form>
  </div>
</div>
