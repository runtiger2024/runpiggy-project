<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é›†é‹å–®æ˜ç´°åˆ—å° - å°è·‘è±¬</title>
    <link rel="icon" href="assets/logo.png" type="image/png" />
    <style>
      /* A4 åˆ—å°æ¨£å¼è¨­å®š */
      @media print {
        @page {
          size: A4;
          margin: 10mm;
        }
        body {
          -webkit-print-color-adjust: exact;
        }
        .no-print {
          display: none !important;
        }
        .page-container {
          box-shadow: none !important;
          margin: 0 !important;
          width: 100% !important;
        }
      }

      body {
        font-family: "Microsoft JhengHei", Arial, sans-serif;
        color: #333;
        background: #555; /* é è¦½èƒŒæ™¯æ·±è‰² */
        margin: 0;
        padding: 20px;
      }

      .page-container {
        background: white;
        max-width: 210mm; /* A4 å¯¬åº¦ */
        min-height: 297mm; /* A4 é«˜åº¦ */
        margin: 0 auto;
        padding: 20mm;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        position: relative;
        box-sizing: border-box;
      }

      .header {
        border-bottom: 2px solid #1a73e8;
        padding-bottom: 10px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo-section img {
        height: 50px;
      }
      .company-info {
        text-align: right;
        font-size: 12px;
        line-height: 1.4;
      }

      h1 {
        color: #1a73e8;
        margin: 0;
        font-size: 24px;
      }

      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 5px;
      }
      .info-item {
        margin-bottom: 5px;
        font-size: 14px;
      }
      .info-item strong {
        min-width: 70px;
        display: inline-block;
        color: #555;
      }

      .package-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        font-size: 13px;
      }
      .package-table th,
      .package-table td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
      }
      .package-table th {
        background-color: #f0f8ff;
        color: #1a73e8;
      }

      .photos-section {
        margin-top: 20px;
        page-break-inside: avoid; /* ç›¡é‡ä¸è¢«åˆ‡æ–· */
      }
      .photos-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr); /* ä¸€è¡Œå››å¼µ */
        gap: 10px;
      }
      .photo-item {
        border: 1px solid #eee;
        padding: 5px;
        text-align: center;
      }
      .photo-item img {
        width: 100%;
        height: 100px;
        object-fit: cover;
        display: block;
      }
      .photo-caption {
        font-size: 10px;
        color: #666;
        margin-top: 3px;
      }

      .footer {
        margin-top: 30px;
        border-top: 1px dashed #ccc;
        padding-top: 10px;
        text-align: center;
        font-size: 12px;
        color: #888;
      }

      /* æ“ä½œæŒ‰éˆ•å€ */
      .action-bar {
        position: fixed;
        top: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .btn {
        padding: 10px 20px;
        background: #1a73e8;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      }
      .btn-back {
        background: #666;
      }

      #loading {
        text-align: center;
        padding: 50px;
        background: white;
      }
    </style>
  </head>
  <body>
    <div class="action-bar no-print">
      <button class="btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å° / å­˜ç‚º PDF</button>
      <button class="btn btn-back" onclick="window.close()">é—œé–‰è¦–çª—</button>
    </div>

    <div id="loading">è¼‰å…¥è³‡æ–™ä¸­...</div>

    <div id="print-content" class="page-container" style="display: none">
      <div class="header">
        <div class="logo-section">
          <img src="assets/logo.png" alt="Logo" />
          <h1>é›†é‹è¨‚å–®æ˜ç´°è¡¨</h1>
        </div>
        <div class="company-info">
          <strong>å…©éš»è€è™åœ‹éš›è²¿æ˜“æœ‰é™å…¬å¸</strong><br />
          Email: 2runtigers@gmail.com<br />
          LINE: @runpiggy
        </div>
      </div>

      <div class="info-grid">
        <div>
          <div class="info-item">
            <strong>è¨‚å–®ç·¨è™Ÿï¼š</strong><span id="p-id"></span>
          </div>
          <div class="info-item">
            <strong>å»ºç«‹æ—¥æœŸï¼š</strong><span id="p-date"></span>
          </div>
          <div class="info-item">
            <strong>è¨‚å–®ç‹€æ…‹ï¼š</strong><span id="p-status"></span>
          </div>
          <div class="info-item">
            <strong>å°ç£å–®è™Ÿï¼š</strong><span id="p-tw-tracking"></span>
          </div>
        </div>
        <div>
          <div class="info-item">
            <strong>æ”¶ä»¶äººï¼š</strong><span id="p-name"></span>
          </div>
          <div class="info-item">
            <strong>é›»è©±ï¼š</strong><span id="p-phone"></span>
          </div>
          <div class="info-item">
            <strong>èº«åˆ†è­‰ï¼š</strong><span id="p-idnum"></span>
          </div>
          <div class="info-item">
            <strong>æ”¶ä»¶åœ°å€ï¼š</strong><span id="p-address"></span>
          </div>
        </div>
      </div>

      <h3>ğŸ“¦ åŒ…è£¹æ¸…å–®</h3>
      <table class="package-table">
        <thead>
          <tr>
            <th style="width: 5%">#</th>
            <th style="width: 25%">ç‰©æµå–®è™Ÿ</th>
            <th style="width: 20%">å•†å“åç¨±</th>
            <th style="width: 10%">ä»¶æ•¸</th>
            <th style="width: 20%">å€‰åº«æ•¸æ“š (é‡é‡/æç©)</th>
            <th style="width: 20%">å‚™è¨»</th>
          </tr>
        </thead>
        <tbody id="p-pkg-body"></tbody>
      </table>

      <div
        class="info-item"
        style="text-align: right; font-size: 16px; margin-top: 10px"
      >
        <strong>ç¸½é‹è²»é‡‘é¡ï¼š</strong>
        <span id="p-total" style="color: #d32f2f; font-weight: bold"></span>
      </div>

      <div class="photos-section">
        <h3>ğŸ“· å•†å“/å€‰åº«ç…§ç‰‡</h3>
        <div class="photos-grid" id="p-photos-grid"></div>
      </div>

      <div class="footer">
        æœ¬å–®æ“šç”±å°è·‘è±¬é›†é‹ç³»çµ±è‡ªå‹•ç”¢ç”Ÿ Â· åˆ—å°æ™‚é–“ï¼š<span id="print-time"></span>
      </div>
    </div>

    <script src="js/apiConfig.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);
        const shipmentId = params.get("id");

        // [é—œéµä¿®æ­£] å˜—è©¦è®€å–æœƒå“¡ Tokenï¼Œå¦‚æœæ²’æœ‰ï¼Œå‰‡è®€å–ç®¡ç†å“¡ Token
        const token =
          localStorage.getItem("token") || localStorage.getItem("admin_token");

        if (!shipmentId || !token) {
          alert("ç„¡æ•ˆçš„é€£çµæˆ–æœªç™»å…¥");
          window.close();
          return;
        }

        try {
          const response = await fetch(
            `${API_BASE_URL}/api/shipments/${shipmentId}`,
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          const data = await response.json();
          if (!response.ok) throw new Error(data.message);

          renderShipment(data.shipment);
          document.getElementById("loading").style.display = "none";
          document.getElementById("print-content").style.display = "block";
        } catch (error) {
          alert("è¼‰å…¥å¤±æ•—ï¼š" + error.message);
        }
      });

      function renderShipment(ship) {
        // ç‹€æ…‹å°ç…§è¡¨
        const shipmentStatusMap = {
          PENDING_PAYMENT: "å¾…ä»˜æ¬¾",
          PROCESSING: "å·²æ”¶æ¬¾ï¼Œå®‰æ’è£æ«ƒ",
          SHIPPED: "å·²è£æ«ƒ",
          COMPLETED: "æµ·é—œæŸ¥é©—",
          CANCELLEDD: "æ¸…é—œæ”¾è¡Œ",
          CANCELL: "æ‹†æ«ƒæ´¾é€",
          CANCEL: "å·²å®Œæˆ",
          CANCELLED: "å·²å–æ¶ˆ/é€€å›",
        };
        // ç‰¹æ®Šç‹€æ…‹ï¼šå¾…ä»˜æ¬¾ä½†æœ‰æ†‘è­‰
        let statusText = shipmentStatusMap[ship.status] || ship.status;
        if (ship.status === "PENDING_PAYMENT" && ship.paymentProof) {
          statusText = "å·²ä»˜æ¬¾ï¼Œå¾…å¯©æ ¸";
        }

        // å¡«å¯«åŸºæœ¬è³‡æ–™
        document.getElementById("p-id").textContent = ship.id
          .slice(-8)
          .toUpperCase(); // åªé¡¯ç¤ºå¾Œ8ç¢¼
        document.getElementById("p-date").textContent = new Date(
          ship.createdAt
        ).toLocaleDateString();
        document.getElementById("p-status").textContent = statusText;
        document.getElementById("p-tw-tracking").textContent =
          ship.trackingNumberTW || "(å°šæœªç”¢ç”Ÿ)";

        document.getElementById("p-name").textContent = ship.recipientName;
        document.getElementById("p-phone").textContent = ship.phone;
        document.getElementById("p-idnum").textContent = ship.idNumber;
        document.getElementById("p-address").textContent = ship.shippingAddress;
        document.getElementById("p-total").textContent = `NT$ ${
          ship.totalCost ? ship.totalCost.toLocaleString() : "0"
        }`;
        document.getElementById("print-time").textContent =
          new Date().toLocaleString();

        // å¡«å¯«åŒ…è£¹è¡¨æ ¼ & æ”¶é›†ç…§ç‰‡
        const tbody = document.getElementById("p-pkg-body");
        const photosGrid = document.getElementById("p-photos-grid");

        ship.packages.forEach((pkg, index) => {
          // è¡¨æ ¼åˆ—
          const tr = document.createElement("tr");

          // è¨ˆç®—ç¸½é‡èˆ‡æç© (è‹¥æœ‰åˆ†ç®±è³‡æ–™)
          let weightInfo = "-";
          if (pkg.arrivedBoxes && pkg.arrivedBoxes.length > 0) {
            const totalW = pkg.arrivedBoxes.reduce(
              (acc, b) => acc + (parseFloat(b.weight) || 0),
              0
            );
            const totalCai = pkg.arrivedBoxes.reduce(
              (acc, b) => acc + (parseFloat(b.cai) || 0),
              0
            ); // ä½¿ç”¨è§£æå¾Œçš„ cain
            weightInfo = `${totalW.toFixed(1)} kg / ${totalCai} æ (${
              pkg.arrivedBoxes.length
            } ç®±)`;
          }

          tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${pkg.trackingNumber}</td>
          <td>${pkg.productName}</td>
          <td>${pkg.quantity}</td>
          <td>${weightInfo}</td>
          <td>${pkg.note || ""}</td>
        `;
          tbody.appendChild(tr);

          // è™•ç†ç…§ç‰‡ (åŒ…å«å®¢æˆ¶ä¸Šå‚³ productImages å’Œ å€‰åº« warehouseImages)
          const allImages = [
            ...(pkg.productImages || []),
            ...(pkg.warehouseImages || []),
          ];

          allImages.forEach((imgUrl) => {
            const div = document.createElement("div");
            div.className = "photo-item";
            div.innerHTML = `
             <img src="${API_BASE_URL}${imgUrl}" alt="photo">
             <div class="photo-caption">${pkg.productName} (${pkg.trackingNumber})</div>
           `;
            photosGrid.appendChild(div);
          });
        });

        if (photosGrid.children.length === 0) {
          photosGrid.innerHTML =
            '<p style="grid-column: 1/-1; text-align: center; color: #999;">æ­¤è¨‚å–®ç„¡ç›¸é—œç…§ç‰‡</p>';
        }
      }
    </script>
  </body>
</html>
