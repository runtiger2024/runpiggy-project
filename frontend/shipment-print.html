<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é›†é‹å‡ºè²¨å–® / å ±é—œæ˜ç´° - å°è·‘è±¬</title>
    <link rel="icon" href="assets/logo.png" type="image/png" />
    <script src="js/styleLoader.js"></script>
    <style>
      :root {
        --border-color: #000; /* åˆ—å°å–®æ“šé€šå¸¸ä½¿ç”¨ç´”é»‘é‚Šæ¡† */
      }

      body {
        font-family: "Microsoft JhengHei", "Heiti TC", Arial, sans-serif;
        background-color: #525659; /* é è¦½æ™‚èƒŒæ™¯æ·±ç°ï¼Œæ¨¡æ“¬ PDF æª¢è¦–å™¨ */
        margin: 0;
        padding: 20px;
        color: #000;
      }

      /* A4 ç´™å¼µæ¨¡æ“¬å®¹å™¨ */
      .page-container {
        background: white;
        width: 210mm;
        min-height: 297mm;
        margin: 0 auto;
        padding: 15mm 15mm; /* æ¨™æº–æ–‡ä»¶é‚Šè· */
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        position: relative;
        box-sizing: border-box;
      }

      /* ---------------- åˆ—å°å°ˆç”¨æ¨£å¼ ---------------- */
      @media print {
        @page {
          size: A4;
          margin: 0; /* ç€è¦½å™¨åˆ—å°é‚Šè·æ­¸é›¶ï¼Œç”± CSS æ§åˆ¶ */
        }
        body {
          background: none;
          padding: 0;
          margin: 0;
          -webkit-print-color-adjust: exact; /* å¼·åˆ¶åˆ—å°èƒŒæ™¯è‰² */
          print-color-adjust: exact;
        }
        .page-container {
          width: 100%;
          min-height: 100vh;
          margin: 0;
          padding: 10mm 15mm; /* åˆ—å°æ™‚çš„ç‰©ç†é‚Šè· */
          box-shadow: none;
          border: none;
        }
        .no-print {
          display: none !important;
        }
        /* å¼·åˆ¶åˆ†é è¨­å®š */
        .page-break {
          page-break-before: always;
        }
      }

      /* ---------------- å ±é—œå–®æ’ç‰ˆæ¨£å¼ ---------------- */

      /* æ¨™é ­å€ */
      .doc-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 10px;
        margin-bottom: 20px;
      }
      .company-brand {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .company-brand img {
        height: 60px;
        filter: grayscale(100%); /* å ±è¡¨é€šå¸¸è½‰ç‚ºé»‘ç™½ä»¥ç¯€çœå¢¨æ°´ï¼Œæˆ–å¯ç§»é™¤æ­¤è¡Œ */
      }
      .company-title h1 {
        margin: 0;
        font-size: 24px;
        letter-spacing: 2px;
        font-weight: 900;
      }
      .company-title span {
        font-size: 14px;
        font-weight: bold;
      }
      .doc-meta {
        text-align: right;
        font-size: 12px;
        line-height: 1.4;
      }
      .doc-title-box {
        text-align: center;
        margin: 20px 0;
      }
      .doc-title-box h2 {
        margin: 0;
        font-size: 22px;
        text-decoration: underline;
        text-underline-offset: 5px;
      }

      /* è³‡è¨Šç¶²æ ¼å€ (Grid) */
      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
        padding: 10px;
      }
      .info-column {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .info-row {
        display: flex;
        font-size: 14px;
      }
      .info-label {
        font-weight: bold;
        min-width: 80px;
      }
      .info-value {
        flex: 1;
        border-bottom: 1px dotted #ccc;
        padding-left: 5px;
      }

      /* æ¨™æº–è¡¨æ ¼æ¨£å¼ */
      .standard-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        font-size: 12px;
      }
      .standard-table th,
      .standard-table td {
        border: 1px solid var(--border-color);
        padding: 6px 8px;
        text-align: center;
      }
      .standard-table th {
        background-color: #f0f0f0;
        font-weight: bold;
        padding: 8px;
      }
      .standard-table td.text-left {
        text-align: left;
      }
      .standard-table td.text-right {
        text-align: right;
      }

      /* ç¸½è¨ˆå€å¡Š */
      .totals-section {
        display: flex;
        justify-content: flex-end;
        margin-top: -21px; /* æ¥åˆè¡¨æ ¼ */
        margin-bottom: 30px;
      }
      .totals-box {
        border: 1px solid var(--border-color);
        border-top: none;
        padding: 10px 20px;
        min-width: 250px;
        font-size: 14px;
      }
      .total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
      }
      .total-row.final {
        font-weight: bold;
        font-size: 16px;
        border-top: 1px solid #ccc;
        padding-top: 5px;
        margin-top: 5px;
      }

      /* ç°½åèˆ‡å‚™è¨»å€ */
      .bottom-section {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        font-size: 14px;
      }
      .remarks-box {
        width: 60%;
        border: 1px solid var(--border-color);
        padding: 10px;
        min-height: 80px;
      }
      .signature-box {
        width: 35%;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        align-items: center;
      }
      .signature-line {
        width: 100%;
        border-bottom: 1px solid var(--border-color);
        margin-top: 40px;
        margin-bottom: 10px;
      }

      /* åœ–ç‰‡å€ (é€šå¸¸å°åœ¨ç¬¬äºŒé ) */
      .photos-header {
        border-bottom: 1px solid #000;
        margin-bottom: 15px;
        padding-bottom: 5px;
        font-size: 16px;
        font-weight: bold;
      }
      .photos-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }
      .photo-wrapper {
        border: 1px solid #ccc;
        padding: 5px;
        text-align: center;
        page-break-inside: avoid;
      }
      .photo-wrapper img {
        width: 100%;
        height: 120px;
        object-fit: contain; /* æ”¹ç‚º contain ç¢ºä¿çœ‹æ¸…å•†å“å…¨è²Œ */
        display: block;
      }
      .photo-caption {
        font-size: 10px;
        margin-top: 5px;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
      }

      /* æ“ä½œæŒ‰éˆ• (ä¸åˆ—å°) */
      .action-bar {
        position: fixed;
        top: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 999;
      }
      .btn {
        padding: 12px 24px;
        background: #1a73e8;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }
      .btn:hover {
        transform: translateY(-2px);
      }
      .btn-secondary {
        background: #5f6368;
      }

      /* æµ®æ°´å° */
      .watermark {
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        font-size: 100px;
        color: rgba(0, 0, 0, 0.03);
        pointer-events: none;
        font-weight: bold;
        white-space: nowrap;
        z-index: 0;
      }
    </style>
  </head>
  <body>
    <div class="action-bar no-print">
      <button class="btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å° / å„²å­˜ PDF</button>
      <button class="btn btn-secondary" onclick="window.close()">
        é—œé–‰è¦–çª—
      </button>
    </div>

    <div
      id="loading"
      style="text-align: center; color: white; margin-top: 100px"
    >
      è³‡æ–™è¼‰å…¥ä¸­...
    </div>

    <div id="print-content" class="page-container" style="display: none">
      <div class="watermark">RUNPIGGY LOGISTICS</div>

      <div class="doc-header">
        <div class="company-brand">
          <img src="assets/logo.png" alt="Logo" />
          <div class="company-title">
            <h1>å°è·‘è±¬é›†é‹</h1>
            <span>RUNPIGGY INTERNATIONAL</span>
          </div>
        </div>
        <div class="doc-meta">
          <div>çµ±ä¸€ç·¨è™Ÿï¼š93669355</div>
          <div>Email: 2runtigers@gmail.com</div>
          <div>LINE: @runpiggy</div>
          <div>åˆ—å°æ™‚é–“: <span id="print-date"></span></div>
        </div>
      </div>

      <div class="doc-title-box">
        <h2>é›†é‹å‡ºè²¨æ˜ç´°å–® / PACKING LIST</h2>
      </div>

      <div class="info-grid">
        <div class="info-column">
          <div class="info-row">
            <span class="info-label">è¨‚å–®ç·¨è™Ÿï¼š</span>
            <span class="info-value" id="p-id"></span>
          </div>
          <div class="info-row">
            <span class="info-label">å»ºç«‹æ—¥æœŸï¼š</span>
            <span class="info-value" id="p-date"></span>
          </div>
          <div class="info-row">
            <span class="info-label">è¨‚å–®ç‹€æ…‹ï¼š</span>
            <span class="info-value" id="p-status"></span>
          </div>
          <div class="info-row">
            <span class="info-label">å°ç£å–®è™Ÿï¼š</span>
            <span class="info-value" id="p-tw-tracking"></span>
          </div>
        </div>
        <div class="info-column">
          <div class="info-row">
            <span class="info-label">æ”¶ä»¶äººï¼š</span>
            <span class="info-value" id="p-name"></span>
          </div>
          <div class="info-row">
            <span class="info-label">è¯çµ¡é›»è©±ï¼š</span>
            <span class="info-value" id="p-phone"></span>
          </div>
          <div class="info-row">
            <span class="info-label">èº«åˆ†è­‰è™Ÿï¼š</span>
            <span class="info-value" id="p-idnum"></span>
          </div>
          <div class="info-row">
            <span class="info-label">é…é€åœ°å€ï¼š</span>
            <span
              class="info-value"
              id="p-address"
              style="font-size: 12px"
            ></span>
          </div>
        </div>
      </div>

      <table class="standard-table">
        <thead>
          <tr>
            <th style="width: 5%">No.</th>
            <th style="width: 20%">ç‰©æµå–®è™Ÿ (Tracking No.)</th>
            <th style="width: 25%">å•†å“åç¨± (Description)</th>
            <th style="width: 8%">ä»¶æ•¸</th>
            <th style="width: 12%">é‡é‡ (KG)</th>
            <th style="width: 12%">æç© (æ)</th>
            <th style="width: 18%">å‚™è¨»</th>
          </tr>
        </thead>
        <tbody id="p-pkg-body"></tbody>
      </table>

      <div class="totals-section">
        <div class="totals-box">
          <div class="total-row">
            <span>ç¸½ä»¶æ•¸ï¼š</span>
            <span id="p-total-qty">0</span>
          </div>
          <div class="total-row">
            <span>ç¸½é‡é‡ï¼š</span>
            <span id="p-total-weight">0.0 kg</span>
          </div>
          <div class="total-row final">
            <span>é‹è²»ç¸½è¨ˆï¼š</span>
            <span id="p-total-cost">NT$ 0</span>
          </div>
        </div>
      </div>

      <div class="bottom-section">
        <div class="remarks-box">
          <strong>å®¢æˆ¶å‚™è¨» / Notes:</strong><br />
          <span id="p-note" style="white-space: pre-wrap; color: #555"></span>
        </div>
        <div class="signature-box">
          <div class="signature-line"></div>
          <div>æ”¶ä»¶äººç°½å / Signature</div>
        </div>
      </div>

      <div class="page-break"></div>

      <div class="photos-section" id="photo-section" style="margin-top: 20px">
        <div class="photos-header">ğŸ“· è²¨ç‰©/å€‰åº«ç…§ç‰‡è¨˜éŒ„ (Photos)</div>
        <div class="photos-grid" id="p-photos-grid"></div>
      </div>
    </div>

    <script src="js/apiConfig.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);
        const shipmentId = params.get("id");

        // 1. åˆ¤æ–·æ¬Šé™ (Admin vs Client)
        const adminToken = localStorage.getItem("admin_token");
        const clientToken = localStorage.getItem("token");

        // æœ‰ adminToken ä»£è¡¨æ˜¯ç®¡ç†å“¡ï¼Œå¯ä»¥çœ‹å®Œæ•´è³‡æ–™
        const isPrivileged = !!adminToken;

        // å„ªå…ˆä½¿ç”¨ adminTokenï¼Œå¦å‰‡ä½¿ç”¨ clientToken
        const token = adminToken || clientToken;

        if (!shipmentId || !token) {
          alert("ç„¡æ•ˆçš„é€£çµæˆ–æœªç™»å…¥");
          window.close();
          return;
        }

        try {
          const response = await fetch(
            `${API_BASE_URL}/api/shipments/${shipmentId}`,
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          const data = await response.json();
          if (!response.ok) throw new Error(data.message);

          // å‚³å…¥æ¬Šé™æ¨™è¨˜é€²è¡Œæ¸²æŸ“
          renderShipment(data.shipment, isPrivileged);

          document.getElementById("loading").style.display = "none";
          document.getElementById("print-content").style.display = "block";

          // å¡«å…¥åˆ—å°æ—¥æœŸ
          const now = new Date();
          document.getElementById(
            "print-date"
          ).textContent = `${now.getFullYear()}/${(now.getMonth() + 1)
            .toString()
            .padStart(2, "0")}/${now
            .getDate()
            .toString()
            .padStart(2, "0")} ${now
            .getHours()
            .toString()
            .padStart(2, "0")}:${now.getMinutes().toString().padStart(2, "0")}`;
        } catch (error) {
          alert("è¼‰å…¥å¤±æ•—ï¼š" + error.message);
          document.getElementById("loading").textContent =
            "è¼‰å…¥å¤±æ•—ï¼Œè«‹é—œé–‰è¦–çª—é‡è©¦";
        }
      });

      /**
       * æ•æ„Ÿè³‡æ–™éš±ç¢¼è™•ç†
       * è‹¥ isPrivileged ç‚º false (ä¸€èˆ¬å®¢æˆ¶)ï¼Œå‰‡éš±è—ä¸­é–“ç¢¼
       */
      function formatSensitiveData(str, type, isPrivileged) {
        if (!str) return "-";
        if (isPrivileged) return str; // ç®¡ç†å“¡çœ‹å…¨éƒ¨

        // å®¢æˆ¶ç«¯éš±ç¢¼é‚è¼¯
        if (type === "phone") {
          // éš±è—é›»è©±ä¸­é–“: 0912345678 -> 09****5678
          if (str.length > 7) {
            return str.substring(0, 2) + "****" + str.substring(str.length - 4);
          }
          return str;
        } else if (type === "id") {
          // éš±è—èº«åˆ†è­‰: A123456789 -> A1*****789 (ä¿ç•™é¦–2æœ«3)
          if (str.length > 6) {
            return (
              str.substring(0, 2) + "*****" + str.substring(str.length - 3)
            );
          }
          // æˆ–è€…ä¾ç…§éœ€æ±‚ï¼šåªç•™æœ«å››ç¢¼
          // return "******" + str.slice(-4);
          return "******" + str.slice(-4);
        }
        return str;
      }

      function renderShipment(ship, isPrivileged) {
        // ç‹€æ…‹å°ç…§
        const shipmentStatusMap = {
          PENDING_PAYMENT: "å¾…ä»˜æ¬¾",
          PENDING_REVIEW: "ä»˜æ¬¾å¯©æ ¸ä¸­",
          PROCESSING: "å·²æ”¶æ¬¾ï¼Œå®‰æ’è£æ«ƒ",
          SHIPPED: "å·²è£æ«ƒå‡ºå£",
          COMPLETED: "å·²å®Œæˆ",
          CANCELLED: "å·²å–æ¶ˆ",
        };
        let statusText = shipmentStatusMap[ship.status] || ship.status;
        if (ship.status === "PENDING_PAYMENT" && ship.paymentProof) {
          statusText = "å·²ä»˜æ¬¾ (å¾…å¯©æ ¸)";
        }

        // --- å¡«å¯«åŸºæœ¬è³‡æ–™ ---
        document.getElementById("p-id").textContent = ship.id
          .slice(-8)
          .toUpperCase();
        document.getElementById("p-date").textContent = new Date(
          ship.createdAt
        ).toLocaleDateString();
        document.getElementById("p-status").textContent = statusText;
        document.getElementById("p-tw-tracking").textContent =
          ship.trackingNumberTW || "å°šæœªç”¢ç”Ÿ";

        // --- æ•æ„Ÿå€‹è³‡è™•ç† ---
        document.getElementById("p-name").textContent = ship.recipientName;
        document.getElementById("p-phone").textContent = formatSensitiveData(
          ship.phone,
          "phone",
          isPrivileged
        );
        document.getElementById("p-idnum").textContent = formatSensitiveData(
          ship.idNumber,
          "id",
          isPrivileged
        );
        document.getElementById("p-address").textContent = ship.shippingAddress;
        document.getElementById("p-note").textContent = ship.note || "ç„¡";

        // --- å¡«å¯«åŒ…è£¹è¡¨æ ¼ ---
        const tbody = document.getElementById("p-pkg-body");
        const photosGrid = document.getElementById("p-photos-grid");

        let totalQty = 0;
        let grandTotalWeight = 0;

        ship.packages.forEach((pkg, index) => {
          const tr = document.createElement("tr");

          // è¨ˆç®—å–®ä¸€åŒ…è£¹æ•¸æ“š
          let weightInfo = "-";
          let pkgWeight = 0;

          if (pkg.arrivedBoxes && pkg.arrivedBoxes.length > 0) {
            // ç´¯åŠ è©²åŒ…è£¹æ‰€æœ‰ç®±å­çš„é‡é‡
            pkgWeight = pkg.arrivedBoxes.reduce(
              (acc, b) => acc + (parseFloat(b.weight) || 0),
              0
            );
            const totalCai = pkg.arrivedBoxes.reduce(
              (acc, b) => acc + (parseFloat(b.cai) || 0),
              0
            ); // å‡è¨­å¾Œç«¯æœ‰å­˜ cai æˆ–éœ€å‰ç«¯é‡ç®—

            // è‹¥å¾Œç«¯æ²’å­˜ caiï¼Œé€™è£¡ç°¡å–®é¡¯ç¤ºç®±æ•¸
            weightInfo = `${pkgWeight.toFixed(1)} kg / ${
              pkg.arrivedBoxes.length
            } ç®±`;
          } else {
            // ç›¸å®¹èˆŠè³‡æ–™
            weightInfo = "(å°šæœªå…¥åº«æ¸¬é‡)";
          }

          grandTotalWeight += pkgWeight;
          totalQty += pkg.quantity;

          tr.innerHTML = `
            <td>${index + 1}</td>
            <td class="text-left" style="font-family: monospace;">${
              pkg.trackingNumber
            }</td>
            <td class="text-left">${pkg.productName}</td>
            <td>${pkg.quantity}</td>
            <td>${pkgWeight > 0 ? pkgWeight.toFixed(1) : "-"}</td>
            <td>-</td> <td class="text-left" style="font-size: 10px;">${
              pkg.note || ""
            }</td>
          `;
          tbody.appendChild(tr);

          // --- è™•ç†ç…§ç‰‡ (å®¢æˆ¶ä¸Šå‚³ + å€‰åº«å¯¦æ‹) ---
          const allImages = [
            ...(pkg.productImages || []), // å¯èƒ½ç‚º JSON string æˆ– Arrayï¼Œè¦–å¾Œç«¯è™•ç†
            ...(pkg.warehouseImages || []),
          ];

          // æ³¨æ„ï¼šå¦‚æœæ˜¯å¾Œç«¯æ²’è§£æ JSONï¼Œéœ€åœ¨æ­¤ try-catch è§£æ (è¦–æ‚¨çš„ API è¼¸å‡ºè€Œå®š)
          // å‡è¨­ API å·²ç¶“è§£æå¥½ç‚º Array

          if (Array.isArray(allImages)) {
            allImages.forEach((imgUrl) => {
              const div = document.createElement("div");
              div.className = "photo-wrapper";
              div.innerHTML = `
                  <img src="${API_BASE_URL}${imgUrl}" alt="photo">
                  <div class="photo-caption">${pkg.productName}</div>
                `;
              photosGrid.appendChild(div);
            });
          }
        });

        // --- æ›´æ–°çµ±è¨ˆæ•¸æ“š ---
        document.getElementById("p-total-qty").textContent = totalQty;
        document.getElementById("p-total-weight").textContent =
          grandTotalWeight.toFixed(1) + " kg";
        document.getElementById("p-total-cost").textContent = `NT$ ${(
          ship.totalCost || 0
        ).toLocaleString()}`;

        // å¦‚æœæ²’æœ‰ç…§ç‰‡ï¼Œéš±è—ç…§ç‰‡å€
        if (photosGrid.children.length === 0) {
          document.getElementById("photo-section").style.display = "none";
        }
      }
    </script>
  </body>
</html>
